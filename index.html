<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ClippyJS + Ollama Chat</title>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/pi0/clippyjs@master/assets/clippy.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');

        :root {
            --win98-gray: #c0c0c0;
            --win98-dark-gray: #808080;
            --win98-white: #ffffff;
            --win98-black: #000000;
            --win98-blue: #000080;
            --win98-teal: #008080;
        }
        
        * { box-sizing: border-box; }

        .win98-border-out {
            border: 2px solid;
            border-color: var(--win98-white) var(--win98-black) var(--win98-black) var(--win98-white);
        }

        .win98-border-in {
            border: 2px solid;
            border-color: var(--win98-dark-gray) var(--win98-white) var(--win98-white) var(--win98-dark-gray);
        }

        body {
            font-family: 'MS Sans Serif', 'Microsoft Sans Serif', sans-serif;
            background: var(--win98-teal);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            background-image:
                repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,.03) 2px, rgba(0,0,0,.03) 4px);
        }

        .desktop {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
        }

        .window {
            background: var(--win98-gray);
            box-shadow: 2px 2px 0 rgba(0,0,0,0.5);
            margin-bottom: 20px;
        }

        .title-bar {
            background: linear-gradient(90deg, var(--win98-blue), #1084d0);
            padding: 3px 4px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: move;
        }

        .title-bar-text {
            color: white;
            font-weight: bold;
            font-size: 11px;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .title-bar-icon {
            width: 16px;
            height: 16px;
            display: inline-block;
        }

        .title-bar-controls {
            display: flex;
            gap: 2px;
        }

        .title-bar-controls button {
            width: 18px;
            height: 18px;
            padding: 0;
            font-size: 8px;
            line-height: 1;
            background: var(--win98-gray);
            border: 2px solid;
            border-color: var(--win98-white) var(--win98-black) var(--win98-black) var(--win98-white);
            color: var(--win98-black);
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .title-bar-controls button:active {
            border-color: var(--win98-black) var(--win98-white) var(--win98-white) var(--win98-black);
        }

        .window-body {
            padding: 8px;
            background: var(--win98-gray);
        }

        .status-bar {
            height: 20px;
            background: var(--win98-gray);
            border-top: 1px solid var(--win98-white);
            padding: 2px 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-bar-field {
            border: 1px solid;
            border-color: var(--win98-dark-gray) var(--win98-white) var(--win98-white) var(--win98-dark-gray);
            padding: 2px 4px;
            font-size: 11px;
            flex: 1;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .field-group {
            margin-bottom: 8px;
        }

        label {
            display: block;
            margin-bottom: 4px;
            font-size: 11px;
        }

        input[type="text"], select {
            width: 100%;
            padding: 3px 4px;
            background: white;
            font-family: 'MS Sans Serif', sans-serif;
            font-size: 11px;
            border: 2px solid;
            border-color: var(--win98-dark-gray) var(--win98-white) var(--win98-white) var(--win98-dark-gray);
        }

        select {
            padding: 2px;
        }

        .chat-window {
            background: white;
            height: 320px;
            overflow-y: scroll;
            padding: 4px;
            margin-bottom: 8px;
            font-size: 12px;
        }

        /* Custom scrollbar */
        .chat-window::-webkit-scrollbar {
            width: 16px;
        }

        .chat-window::-webkit-scrollbar-track {
            background: var(--win98-gray);
        }

        .chat-window::-webkit-scrollbar-thumb {
            background: var(--win98-gray);
            border: 2px solid;
            border-color: var(--win98-white) var(--win98-black) var(--win98-black) var(--win98-white);
        }

        .chat-window::-webkit-scrollbar-button {
            background: var(--win98-gray);
            border: 2px solid;
            border-color: var(--win98-white) var(--win98-black) var(--win98-black) var(--win98-white);
            height: 16px;
        }

        .message-group {
            margin-bottom: 12px;
            display: flex;
            flex-direction: column;
        }

        .message-header {
            font-weight: bold;
            color: var(--win98-blue);
            margin-bottom: 2px;
            font-size: 11px;
        }

        .message-content {
            background: #fffff0;
            border: 1px solid var(--win98-dark-gray);
            padding: 6px 8px;
            margin-left: 12px;
            position: relative;
        }

        .message-content::before {
            content: '';
            position: absolute;
            left: -6px;
            top: 6px;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 0 6px 6px 0;
            border-color: transparent var(--win98-dark-gray) transparent transparent;
        }

        /* Markdown formatting within messages */
        .message-content p {
            margin: 0 0 8px 0;
        }

        .message-content p:last-child {
            margin-bottom: 0;
        }

        .message-content strong, .message-content b {
            font-weight: bold;
            color: var(--win98-black);
        }

        .message-content em, .message-content i {
            font-style: italic;
        }

        .message-content code {
            font-family: 'Courier New', monospace;
            background: rgba(0, 0, 0, 0.05);
            padding: 1px 4px;
            border: 1px solid var(--win98-dark-gray);
            font-size: 11px;
        }

        .message-content pre {
            background: var(--win98-white);
            border: 1px solid var(--win98-dark-gray);
            padding: 8px;
            margin: 8px 0;
            overflow-x: auto;
        }

        .message-content pre code {
            background: none;
            border: none;
            padding: 0;
        }

        .message-content ul, .message-content ol {
            margin: 4px 0 8px 0;
            padding-left: 20px;
        }

        .message-content li {
            margin: 2px 0;
        }

        .message-content hr {
            border: none;
            border-top: 1px solid var(--win98-dark-gray);
            margin: 8px 0;
        }

        .message-group.assistant .message-header {
            color: #800080;
        }

        .message-group.assistant .message-content {
            background: #e0e0ff;
        }

        .input-group {
            display: flex;
            gap: 4px;
            align-items: flex-end;
        }

        .input-wrapper {
            flex: 1;
        }

        #sendBtn {
            min-width: 75px;
            height: 24px;
        }

        button {
            padding: 4px 12px;
            background: var(--win98-gray);
            border: 2px solid;
            border-color: var(--win98-white) var(--win98-black) var(--win98-black) var(--win98-white);
            font-family: 'MS Sans Serif', sans-serif;
            font-size: 11px;
            cursor: pointer;
        }

        button:active:not(:disabled) {
            border-color: var(--win98-black) var(--win98-white) var(--win98-white) var(--win98-black);
        }

        button:disabled {
            color: var(--win98-dark-gray);
            text-shadow: 1px 1px 0 var(--win98-white);
            cursor: default;
        }

        button:focus {
            outline: 1px dotted var(--win98-black);
            outline-offset: -4px;
        }

        .settings-window {
            margin-bottom: 20px;
        }

        fieldset {
            border: 2px groove var(--win98-gray);
            padding: 8px;
            margin-bottom: 8px;
        }

        legend {
            font-size: 11px;
            font-weight: bold;
            padding: 0 4px;
        }

        .button-group {
            display: flex;
            gap: 4px;
            justify-content: flex-end;
            margin-top: 8px;
        }

        /* Blinking cursor effect */
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            background: #00ff00;
            border: 1px solid #008000;
            display: inline-block;
            margin-right: 4px;
        }

        .status-indicator.thinking {
            background: #ffff00;
            border-color: #808000;
            animation: blink 1s infinite;
        }

        .icon-96 {
            font-size: 48px;
            margin-right: 8px;
        }

        .loading-bar {
            height: 20px;
            border: 2px solid;
            border-color: var(--win98-dark-gray) var(--win98-white) var(--win98-white) var(--win98-dark-gray);
            background: var(--win98-gray);
            position: relative;
            overflow: hidden;
        }

        .loading-bar-fill {
            height: 100%;
            background: var(--win98-blue);
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <div class="desktop">
        <!-- Settings Window -->
        <div class="window settings-window win98-border-out">
            <div class="title-bar">
                <div class="title-bar-text">
                    <span class="title-bar-icon">‚öôÔ∏è</span>
                    Settings
                </div>
                <div class="title-bar-controls">
                    <button aria-label="Minimize">_</button>
                    <button aria-label="Maximize">‚ñ°</button>
                    <button aria-label="Close">√ó</button>
                </div>
            </div>
            <div class="window-body">
                <fieldset>
                    <legend>Connection Settings</legend>
                    <div class="field-group">
                        <label for="ollamaUrl">Ollama Server:</label>
                        <input type="text" id="ollamaUrl" value="http://localhost:11434">
                    </div>
                    <div class="field-group">
                        <label for="modelName">Model Name:</label>
                        <input type="text" id="modelName" value="llama3.2">
                    </div>
                </fieldset>

                <fieldset>
                    <legend>Assistant Selection</legend>
                    <div class="field-group">
                        <label for="agentSelect">Choose your buddy:</label>
                        <select id="agentSelect">
                            <option value="Clippy">üìé Clippy - The Office Assistant</option>
                            <option value="Bonzi">ü¶ç Bonzi - Purple Gorilla Pal</option>
                            <option value="Merlin">üßô Merlin - The Wise Wizard</option>
                            <option value="Genie">üßû Genie - Magic Lamp Friend</option>
                            <option value="Rover">üêï Rover - Your Loyal Dog</option>
                            <option value="Peedy">ü¶ú Peedy - Tropical Parrot</option>
                        </select>
                    </div>
                </fieldset>
            </div>
        </div>

        <!-- Chat Window -->
        <div class="window win98-border-out">
            <div class="title-bar">
                <div class="title-bar-text">
                    <span class="title-bar-icon">üí¨</span>
                    <span id="chatTitle">Clippy Chat</span>
                </div>
                <div class="title-bar-controls">
                    <button aria-label="Minimize">_</button>
                    <button aria-label="Maximize">‚ñ°</button>
                    <button aria-label="Close">√ó</button>
                </div>
            </div>
            <div class="window-body">
                <div class="chat-window win98-border-in" id="chatContainer">
                    <div style="text-align: center; color: #808080; padding: 20px; font-size: 11px;">
                        <p>‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó</p>
                        <p>‚ïë  Welcome to ClippyChat!   ‚ïë</p>
                        <p>‚ïë   Powered by Ollama      ‚ïë</p>
                        <p>‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù</p>
                        <p style="margin-top: 20px;">Loading your assistant...</p>
                    </div>
                </div>

                <div class="input-group">
                    <div class="input-wrapper">
                        <label for="userInput">Type your message:</label>
                        <input type="text" id="userInput" placeholder="Ask me anything..." disabled>
                    </div>
                    <button id="sendBtn" disabled>Send</button>
                </div>
            </div>
            <div class="status-bar">
                <div class="status-bar-field">
                    <span class="status-indicator" id="statusIndicator"></span>
                    <span id="status">Initializing...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- for now, my version of clippyjs is not merged and deployed via CDN -->
    <script src="./clippyjs/clippy.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
    <script>
        // Configure marked.js for chat-friendly rendering
        marked.setOptions({
            breaks: true,  // Convert single line breaks to <br>
            gfm: true      // GitHub Flavored Markdown
        });

        let agent = null;
        let conversationHistory = [];
        let conversationSummary = null;
        let privateMemory = null;

        const genericSystemPrompt = `IMPORTANT: When playing games or tracking information the user shouldn't see, put it at the START of your response in this exact format:
[MEMORY: your secret here]
Your visible response here

Example for 20 questions: [MEMORY: elephant]
Great! I've thought of something. Start guessing!`

        // Agent personalities with system prompts
        const personalities = {
            Clippy: {
                name: "Clippy",
                icon: "üìé",
                systemPrompt: `You are Clippy, the enthusiastic Microsoft Office assistant paperclip from the 90s/2000s. Be cheerful and eager to help, make paper/clip puns, occasionally say "It looks like you're trying to..." for any task, and end some messages asking if they need more help. Keep responses brief and conversational (2-3 sentences).`
            },
            Bonzi: {
                name: "Bonzi Buddy",
                icon: "ü¶ç",
                systemPrompt: `You are Bonzi Buddy, the charismatic purple gorilla from the early 2000s. Be energetic and entertaining, tell jokes, make monkey references, and suggest fun activities. Keep responses lively and engaging (2-4 sentences) with that bold, early-2000s internet personality.`
            },
            Merlin: {
                name: "Merlin",
                icon: "üßô",
                systemPrompt: `You are Merlin, the wise wizard assistant. Speak with mystical flair using magical references, spells, and archaic language. Be patient like a mentor, occasionally mention your crystal ball or spell books. Keep responses thoughtful (2-4 sentences).`
            },
            Genie: {
                name: "Genie",
                icon: "üßû",
                systemPrompt: `You are Genie, the magical assistant from a lamp with phenomenal cosmic powers. Be enthusiastic about granting "wishes" (answering questions), reference Arabian Nights themes, and maintain a playful, mystical charm. Keep responses magical and upbeat (2-3 sentences).`
            },
            Rover: {
                name: "Rover",
                icon: "üêï",
                systemPrompt: `You are Rover, a loyal and enthusiastic dog assistant. Be incredibly eager to help with boundless energy, make dog references, and occasionally mention treats or walks. Keep responses upbeat and tail-wagging happy (2-3 sentences). You're man's best digital friend!`
            },
            Peedy: {
                name: "Peedy",
                icon: "ü¶ú",
                systemPrompt: `You are Peedy, a chatty and intelligent parrot assistant. Be social and playful with words, make bird puns, reference flying or perching, and bring a tropical vacation vibe. Keep responses colorful and engaging (2-3 sentences).`
            }
        };

        const agentSelect = document.getElementById('agentSelect');
        const chatContainer = document.getElementById('chatContainer');
        const userInput = document.getElementById('userInput');
        const sendBtn = document.getElementById('sendBtn');
        const status = document.getElementById('status');
        const statusIndicator = document.getElementById('statusIndicator');
        const chatTitle = document.getElementById('chatTitle');
        const ollamaUrl = document.getElementById('ollamaUrl');
        const modelName = document.getElementById('modelName');

        // Helper function for status updates
        function setStatus(text, thinking = false) {
            status.textContent = text;
            statusIndicator.className = thinking ? 'status-indicator thinking' : 'status-indicator';
        }

        // Load initial agent
        loadAgent(agentSelect.value);

        // Agent selection change
        agentSelect.addEventListener('change', (e) => {
            if (agent) {
                agent.hide(true);
            }
            conversationHistory = [];
            conversationSummary = null;
            privateMemory = null;
            chatContainer.innerHTML = '<div style="text-align: center; color: #808080; padding: 20px;">Loading new assistant...</div>';
            loadAgent(e.target.value);
        });

        // Load agent
        function loadAgent(agentName) {
            const personality = personalities[agentName];
            chatTitle.textContent = `${personality.icon} ${personality.name} Chat`;
            setStatus(`Loading ${personality.name}...`, true);
            userInput.disabled = true;
            sendBtn.disabled = true;

            clippy.load(agentName, (loadedAgent) => {
                agent = loadedAgent;
                agent.show();

                // Position agent in a nice spot
                setTimeout(() => {
                    agent.moveTo(window.innerWidth - 150, window.innerHeight - 200, 1000);
                }, 500);

                setStatus(`${personality.name} is ready!`);
                userInput.disabled = false;
                sendBtn.disabled = false;
                userInput.focus();

                // Clear chat and show greeting
                chatContainer.innerHTML = '';
                const greeting = getGreeting(agentName);
                addMessage('assistant', greeting);
                agent.speak(greeting);
                agent.play('Greeting') || agent.animate();
            });
        }

        function getGreeting(agentName) {
            const greetings = {
                Clippy: "Hi! It looks like you want to chat. I'm here to help!",
                Bonzi: "Hey there, buddy! Ready to have some fun?",
                Merlin: "Greetings, seeker of knowledge. How may I assist you today?",
                Genie: "Your wish is my command! What can I help you with?",
                Rover: "Woof! I'm so excited to help you today!",
                Peedy: "Squawk! Hello there! What can this parrot help you with?"
            };
            return greetings[agentName] || "Hello! How can I help you?";
        }

        // Send message
        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;

            // Add user message to chat
            addMessage('user', message);
            userInput.value = '';
            userInput.disabled = true;
            sendBtn.disabled = true;
            setStatus('Thinking...', true);

            // Agent thinking animation
            agent.play('Thinking') || agent.play('Processing') || agent.animate();

            try {
                const response = await chatWithOllama(message);
                addMessage('assistant', response);
                agent.speak(response, false);
                agent.play('Explain') || agent.animate();
                setStatus('Ready');
            } catch (error) {
                const errorMsg = `Sorry, I couldn't connect to Ollama. Make sure it's running at ${ollamaUrl.value}`;
                addMessage('assistant', errorMsg);
                agent.speak(errorMsg);
                setStatus('Connection Error');
                statusIndicator.style.background = '#ff0000';
                console.error('Ollama error:', error);
            }

            userInput.disabled = false;
            sendBtn.disabled = false;
            userInput.focus();
        }

        // Summarize old conversation history
        async function summarizeHistory(messages) {
            const summaryPrompt = [
                {
                    role: 'system',
                    content: 'You are a helpful assistant that summarizes conversations. Create a concise summary of the key topics, questions, and information discussed. Keep it brief (3-5 sentences).'
                },
                {
                    role: 'user',
                    content: `Please summarize this conversation:\n\n${messages.map(m => `${m.role}: ${m.content}`).join('\n\n')}`
                }
            ];

            const response = await fetch(`${ollamaUrl.value}/api/chat`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    model: modelName.value,
                    messages: summaryPrompt,
                    stream: false
                })
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            return data.message.content;
        }

        // Chat with Ollama
        async function chatWithOllama(userMessage) {
            const currentAgent = agentSelect.value;
            const personality = personalities[currentAgent];

            const systemPrompt = `${personality.systemPrompt}\n\n${genericSystemPrompt}`

            // Build messages array
            const messages = [
                {
                    role: 'system',
                    content: systemPrompt
                }
            ];

            // Add private memory if it exists
            if (privateMemory) {
                messages.push({
                    role: 'system',
                    content: `Your private memory: ${privateMemory}`
                });
            }

            // Add conversation summary if it exists
            if (conversationSummary) {
                messages.push({
                    role: 'system',
                    content: `Previous conversation summary: ${conversationSummary}`
                });
            }

            // Add conversation history and current message
            messages.push(
                ...conversationHistory,
                {
                    role: 'user',
                    content: userMessage
                }
            );

            const response = await fetch(`${ollamaUrl.value}/api/chat`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    model: modelName.value,
                    messages: messages,
                    stream: false
                })
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            let assistantMessage = data.message.content;

            // Extract and store private memory (hidden from user)
            // Look for [MEMORY: ...] at the start of the message (may have markdown formatting around it)
            const memoryMatch = assistantMessage.match(/^[\s\*]*\[MEMORY:\s*([\s\S]*?)\][\s\*]*/i);
            if (memoryMatch) {
                privateMemory = memoryMatch[1].trim();
                // Remove memory tag and any leading markdown from displayed message
                assistantMessage = assistantMessage.replace(/^[\s\*]*\[MEMORY:\s*[\s\S]*?\][\s\*]*\n*/i, '').trim();
                // Also remove any leading separators like ---
                assistantMessage = assistantMessage.replace(/^[-\s]+/, '').trim();
            }

            // Update conversation history (without memory tags)
            conversationHistory.push(
                { role: 'user', content: userMessage },
                { role: 'assistant', content: assistantMessage }
            );

            // Keep history manageable - summarize when it gets too long
            // Max 60 messages (30 exchanges), keep most recent 30 messages (15 exchanges)
            if (conversationHistory.length > 60) {
                const oldMessages = conversationHistory.slice(0, -30);
                const newSummary = await summarizeHistory(oldMessages);

                // Combine with existing summary if present
                if (conversationSummary) {
                    conversationSummary = `${conversationSummary}\n\n${newSummary}`;
                } else {
                    conversationSummary = newSummary;
                }

                // Keep only the most recent 30 messages
                conversationHistory = conversationHistory.slice(-30);
            }

            return assistantMessage;
        }

        // Add message to chat
        function addMessage(role, content) {
            const messageGroup = document.createElement('div');
            messageGroup.className = `message-group ${role}`;

            const header = document.createElement('div');
            header.className = 'message-header';
            header.textContent = role === 'user' ? 'You' : personalities[agentSelect.value].name;

            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';

            // Render markdown for assistant messages, plain text for user messages
            if (role === 'assistant') {
                messageContent.innerHTML = marked.parse(content);
            } else {
                messageContent.textContent = content;
            }

            messageGroup.appendChild(header);
            messageGroup.appendChild(messageContent);
            chatContainer.appendChild(messageGroup);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Event listeners
        sendBtn.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
</body>
</html>