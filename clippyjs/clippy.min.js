!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).clippy=e()}(this,function(){"use strict";class t{constructor(t){this._queue=[],this._onEmptyCallback=t}queue(t){this._queue.push(t),1!==this._queue.length||this._active||this._progressQueue()}_progressQueue(){if(!this._queue.length)return void this._onEmptyCallback();let t=this._queue.shift();this._active=!0,t(this.next.bind(this))}clear(){this._queue=[]}next(){this._active=!1,this._progressQueue()}}class e{constructor(t,e,i,s){this._el=t,this._data=i,this._path=e,this._currentFrameIndex=0,this._currentFrame=void 0,this._exiting=!1,this._currentAnimation=void 0,this._endCallback=void 0,this._started=!1,this._sounds={},this.currentAnimationName=void 0,this.preloadSounds(s),this._overlays=[this._el];let n=this._el;this._setupElement(this._el);for(let t=1;t<this._data.overlayCount;t++){let t=this._setupElement(document.createElement("div"));n.appendChild(t),this._overlays.push(t),n=t}}_setupElement(t){let e=this._data.framesize;return t.style.display="none",t.style.width=e[0]+"px",t.style.height=e[1]+"px",t.style.background="url('"+this._path+"/map.png') no-repeat",t}animations(){let t=[],e=this._data.animations;for(let i in e)t.push(i);return t}preloadSounds(t){for(let e=0;e<this._data.sounds.length;e++){let i=this._data.sounds[e],s=t[i];s&&(this._sounds[i]=new Audio(s))}}hasAnimation(t){return!!this._data.animations[t]}exitAnimation(){this._exiting=!0}showAnimation(t,e){return this._exiting=!1,!!this.hasAnimation(t)&&(this._currentAnimation=this._data.animations[t],this.currentAnimationName=t,this._started||(this._step(),this._started=!0),this._currentFrameIndex=0,this._currentFrame=void 0,this._endCallback=e,!0)}_draw(){let t=[];this._currentFrame&&(t=this._currentFrame.images||[]);for(let e=0;e<this._overlays.length;e++)if(e<t.length){let i=t[e],s=-i[0]+"px "+-i[1]+"px";this._overlays[e].style.backgroundPosition=s,this._overlays[e].style.display="block"}else this._overlays[e].style.display="none"}_getNextAnimationFrame(){if(!this._currentAnimation)return;if(!this._currentFrame)return 0;let t=this._currentFrame,e=this._currentFrame.branching;if(this._exiting&&void 0!==t.exitBranch)return t.exitBranch;if(e){let t=100*Math.random();for(let i=0;i<e.branches.length;i++){let s=e.branches[i];if(t<=s.weight)return s.frameIndex;t-=s.weight}}return this._currentFrameIndex+1}_playSound(){let t=this._currentFrame.sound;if(!t)return;let e=this._sounds[t];e&&e.play().catch(()=>{})}_atLastFrame(){return this._currentFrameIndex>=this._currentAnimation.frames.length-1}_step(){if(!this._currentAnimation)return;let t=Math.min(this._getNextAnimationFrame(),this._currentAnimation.frames.length-1),i=!this._currentFrame||this._currentFrameIndex!==t;this._currentFrameIndex=t,this._atLastFrame()&&this._currentAnimation.useExitBranching||(this._currentFrame=this._currentAnimation.frames[this._currentFrameIndex]),this._draw(),this._playSound(),this._loop=window.setTimeout(this._step.bind(this),this._currentFrame.duration),this._endCallback&&i&&this._atLastFrame()&&(this._currentAnimation.useExitBranching&&!this._exiting?this._endCallback(this.currentAnimationName,e.States.WAITING):this._endCallback(this.currentAnimationName,e.States.EXITED))}pause(){window.clearTimeout(this._loop)}resume(){this._step()}}e.States={WAITING:1,EXITED:0};class i{constructor(t){this._targetEl=t,this._hidden=!0,this._setup(),this.WORD_SPEAK_TIME=200,this.CLOSE_BALLOON_DELAY=2e3,this._BALLOON_MARGIN=15}_setup(){this._balloon=document.createElement("div"),this._balloon.className="clippy-balloon",this._balloon.style.display="none";const t=document.createElement("div");t.className="clippy-tip",this._content=document.createElement("div"),this._content.className="clippy-content",this._balloon.appendChild(t),this._balloon.appendChild(this._content),document.body.appendChild(this._balloon)}reposition(){let t=["top-left","top-right","bottom-left","bottom-right"];for(let e=0;e<t.length;e++){let i=t[e];if(this._position(i),!this._isOut())break}}_position(t){let e,i,s=this._targetEl.getBoundingClientRect(),n=this._targetEl.offsetHeight,o=this._targetEl.offsetWidth,h=this._balloon.offsetHeight,a=this._balloon.offsetWidth;switch(this._balloon.classList.remove("clippy-top-left","clippy-top-right","clippy-bottom-right","clippy-bottom-left"),t){case"top-left":e=s.left+o-a,i=s.top-h-this._BALLOON_MARGIN;break;case"top-right":e=s.left,i=s.top-h-this._BALLOON_MARGIN;break;case"bottom-right":e=s.left,i=s.top+n+this._BALLOON_MARGIN;break;case"bottom-left":e=s.left+o-a,i=s.top+n+this._BALLOON_MARGIN}this._balloon.style.top=i+"px",this._balloon.style.left=e+"px",this._balloon.classList.add("clippy-"+t)}_isOut(){let t=this._balloon.getBoundingClientRect(),e=this._balloon.offsetHeight,i=this._balloon.offsetWidth,s=window.innerWidth,n=window.innerHeight,o=t.top,h=t.left;return o-5<0||h-5<0||(o+e+5>n||h+i+5>s)}speak(t,e,i){this._hidden=!1,this.show();let s=this._content;s.style.height="auto",s.style.width="auto",s.textContent=e,s.style.height=s.offsetHeight+"px",s.style.width=s.offsetWidth+"px",s.textContent="",this.reposition(),this._complete=t,this._sayWords(e,i,t)}show(){this._hidden||(this._balloon.style.display="block")}hide(t){t?this._balloon.style.display="none":this._hiding=window.setTimeout(this._finishHideBalloon.bind(this),this.CLOSE_BALLOON_DELAY)}_finishHideBalloon(){this._active||(this._balloon.style.display="none",this._hidden=!0,this._hiding=null)}_sayWords(t,e,i){this._active=!0,this._hold=e;let s=t.split(/[^\S-]/),n=this.WORD_SPEAK_TIME,o=this._content,h=1;this._addWord=()=>{this._active&&(h>s.length?(delete this._addWord,this._active=!1,this._hold||(i(),this.hide())):(o.textContent=s.slice(0,h).join(" "),h++,this._loop=window.setTimeout(this._addWord,n)))},this._addWord()}close(){this._active?this._hold=!1:this._hold&&this._complete()}pause(){window.clearTimeout(this._loop),this._hiding&&(window.clearTimeout(this._hiding),this._hiding=null)}resume(){this._addWord?this._addWord():this._hold||this._hidden||(this._hiding=window.setTimeout(this._finishHideBalloon.bind(this),this.CLOSE_BALLOON_DELAY))}}class s{constructor(s,n,o){this.path=s,this._queue=new t(this._onQueueEmpty.bind(this)),this._el=document.createElement("div"),this._el.className="clippy",this._el.style.display="none",document.body.appendChild(this._el),this._animator=new e(this._el,s,n,o),this._balloon=new i(this._el),this._setupEvents()}gestureAt(t,e){let i=this._getDirection(t,e),s="Gesture"+i,n="Look"+i,o=this.hasAnimation(s)?s:n;return this.play(o)}hide(t,e){this._hidden=!0;let i=this._el;return this.stop(),t?(this._el.style.display="none",this.stop(),this.pause(),void(e&&e())):this._playInternal("Hide",function(){i.style.display="none",this.pause(),e&&e()})}moveTo(t,i,s){let n="Move"+this._getDirection(t,i);void 0===s&&(s=1e3),this._addToQueue(function(o){if(0===s)return this._el.style.top=i+"px",this._el.style.left=t+"px",this.reposition(),void o();if(!this.hasAnimation(n))return void this._animate(this._el,{top:i,left:t},s,o);this._playInternal(n,(n,h)=>{h===e.States.EXITED&&o(),h===e.States.WAITING&&this._animate(this._el,{top:i,left:t},s,()=>{this._animator.exitAnimation()})})},this)}_animate(t,e,i,s){const n=performance.now(),o={};for(let i in e){const e=parseFloat(getComputedStyle(t)[i])||0;o[i]=e}const h=a=>{const l=a-n,r=Math.min(l/i,1),d=(_=r,.5-Math.cos(_*Math.PI)/2);var _;for(let i in e){const s=o[i],n=s+(e[i]-s)*d;t.style[i]=n+"px"}r<1?requestAnimationFrame(h):s&&s()};requestAnimationFrame(h)}_playInternal(t,e){this._isIdleAnimation()&&this._idlePromise?this._idlePromise.then(()=>{this._playInternal(t,e)}):this._animator.showAnimation(t,e)}play(t,i,s){return!!this.hasAnimation(t)&&(void 0===i&&(i=5e3),this._addToQueue(function(n){let o=!1;i&&window.setTimeout(()=>{o||this._animator.exitAnimation()},i),this._playInternal(t,function(t,i){i===e.States.EXITED&&(o=!0,s&&s(),n())})},this),!0)}show(t){if(this._hidden=!1,t)return this._el.style.display="block",this.resume(),void this._onQueueEmpty();const e=getComputedStyle(this._el);if("auto"===e.top||"auto"===e.left){let t=.8*window.innerWidth,e=.8*(window.innerHeight+window.pageYOffset);this._el.style.top=e+"px",this._el.style.left=t+"px"}return this.resume(),this.play("Show")}speak(t,e){this._addToQueue(function(i){this._balloon.speak(i,t,e)},this)}closeBalloon(){this._balloon.hide()}delay(t){t=t||250,this._addToQueue(function(e){this._onQueueEmpty(),window.setTimeout(e,t)})}stopCurrent(){this._animator.exitAnimation(),this._balloon.close()}stop(){this._queue.clear(),this._animator.exitAnimation(),this._balloon.hide()}hasAnimation(t){return this._animator.hasAnimation(t)}animations(){return this._animator.animations()}animate(){let t=this.animations(),e=t[Math.floor(Math.random()*t.length)];return 0===e.indexOf("Idle")?this.animate():this.play(e)}_getDirection(t,e){let i=this._el.getBoundingClientRect(),s=this._el.offsetHeight,n=this._el.offsetWidth,o=i.left+n/2,h=i.top+s/2-e,a=o-t,l=Math.round(180*Math.atan2(h,a)/Math.PI);return-45<=l&&l<45?"Right":45<=l&&l<135?"Up":135<=l&&l<=180||-180<=l&&l<-135?"Left":-135<=l&&l<-45?"Down":"Top"}_onQueueEmpty(){if(this._hidden||this._isIdleAnimation())return;let t=this._getIdleAnimation();this._idlePromise=new Promise(t=>{this._idleResolve=t}),this._animator.showAnimation(t,this._onIdleComplete.bind(this))}_onIdleComplete(t,i){i===e.States.EXITED&&(this._idleResolve&&this._idleResolve(),this._idlePromise=null,this._idleResolve=null)}_isIdleAnimation(){let t=this._animator.currentAnimationName;return t&&0===t.indexOf("Idle")}_getIdleAnimation(){let t=this.animations(),e=[];for(let i=0;i<t.length;i++){let s=t[i];0===s.indexOf("Idle")&&e.push(s)}return e[Math.floor(Math.random()*e.length)]}_setupEvents(){window.addEventListener("resize",this.reposition.bind(this)),this._el.addEventListener("mousedown",this._onMouseDown.bind(this)),this._el.addEventListener("dblclick",this._onDoubleClick.bind(this))}_onDoubleClick(){this.play("ClickedOn")||this.animate()}reposition(){const t=getComputedStyle(this._el);if("none"===t.display)return;if("hidden"===t.visibility)return;if("0"===t.width||"0"===t.height)return;let e=this._el.getBoundingClientRect(),i=this._el.offsetHeight,s=this._el.offsetWidth,n=window.innerWidth,o=window.innerHeight,h=e.top,a=e.left;h-5<0?h=5:h+i+5>o&&(h=o-i-5),a-5<0?a=5:a+s+5>n&&(a=n-s-5),this._el.style.left=a+"px",this._el.style.top=h+"px",this._balloon.reposition()}_onMouseDown(t){t.preventDefault(),this._startDrag(t)}_startDrag(t){this.pause(),this._balloon.hide(!0),this._offset=this._calculateClickOffset(t),this._moveHandle=this._dragMove.bind(this),this._upHandle=this._finishDrag.bind(this),window.addEventListener("mousemove",this._moveHandle),window.addEventListener("mouseup",this._upHandle),this._dragUpdateLoop=window.setTimeout(this._updateLocation.bind(this),10)}_calculateClickOffset(t){let e=t.pageX,i=t.pageY,s=this._el.getBoundingClientRect();return{top:i-(s.top+window.pageYOffset),left:e-(s.left+window.pageXOffset)}}_updateLocation(){this._el.style.top=this._targetY+"px",this._el.style.left=this._targetX+"px",this._dragUpdateLoop=window.setTimeout(this._updateLocation.bind(this),10)}_dragMove(t){t.preventDefault();let e=t.clientX-this._offset.left,i=t.clientY-this._offset.top;this._targetX=e,this._targetY=i}_finishDrag(){window.clearTimeout(this._dragUpdateLoop),window.removeEventListener("mousemove",this._moveHandle),window.removeEventListener("mouseup",this._upHandle),this._balloon.show(),this.reposition(),this.resume()}_addToQueue(t,e){e&&(t=t.bind(e)),this._queue.queue(t)}pause(){this._animator.pause(),this._balloon.pause()}resume(){this._animator.resume(),this._balloon.resume()}}const n={},o={},h={},a={},l={};function r(t){let e=document.createElement("script");e.setAttribute("src",t),e.setAttribute("async","async"),e.setAttribute("type","text/javascript"),document.head.appendChild(e)}const d={Agent:s,Animator:e,Queue:t,Balloon:i,load:function(t,e,i,d){let _,u,p=(d=d||window.CLIPPY_CDN||"https://cdn.jsdelivr.net/gh/pi0/clippyjs@master/assets/agents/")+t,c=function(t){let e=n[t];return e||(e=n[t]=new Promise((e,i)=>{let s=t+"/map.png",n=new Image;n.onload=e,n.onerror=i,n.setAttribute("src",s)}),e)}(p),m=function(t,e){let i=h[t];return i||(i=h[t]=new Promise((e,i)=>{a[t]={resolve:e,reject:i}}),r(e+"/agent.js"),i)}(t,p),f=function(t,e){let i=o[t];return i||(i=o[t]=new Promise((i,s)=>{let n=document.createElement("audio"),o=!!n.canPlayType&&""!==n.canPlayType("audio/mpeg"),h=!!n.canPlayType&&""!==n.canPlayType('audio/ogg; codecs="vorbis"');if(o||h){let n=e+(o?"/sounds-mp3.js":"/sounds-ogg.js");l[t]={resolve:i,reject:s},r(n)}else i({})}),i)}(t,p);m.then(function(t){_=t}),f.then(function(t){u=t}),Promise.all([c,m,f]).then(function(){let t=new s(p,_,u);e(t)}).catch(i)},ready:function(t,e){let i=a[t];i&&i.resolve&&i.resolve(e)},soundsReady:function(t,e){let i=l[t];i&&i.resolve&&i.resolve(e)}};return"undefined"!=typeof window&&(window.clippy=d),d});
//# sourceMappingURL=clippy.min.js.map
